name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend:
    name: Backend (Laravel)
    runs-on: ubuntu-latest
    services: {}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v4
        with:
          php-version: '8.2'
          ini-values: post_max_size=256M,upload_max_filesize=256M

      - name: Setup composer auth (if private repos)
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        run: |
          echo "COMPOSER_AUTH set"

      - name: Install composer dependencies
        run: composer install --no-progress --no-suggest --prefer-dist --optimize-autoloader

      - name: Create .env
        run: |
          cp qava-api/.env.example qava-api/.env
          echo "APP_KEY=${{ secrets.APP_KEY }}" >> qava-api/.env
          # Use sqlite for tests
          echo "DB_CONNECTION=sqlite" >> qava-api/.env
          echo "DB_DATABASE=:memory:" >> qava-api/.env
        working-directory: ./qava-api

      - name: Generate app key
        working-directory: ./qava-api
        run: php artisan key:generate --ansi

      - name: Run migrations (testing)
        working-directory: ./qava-api
        run: php artisan migrate --force

      - name: Run backend tests
        working-directory: ./qava-api
        run: |
          composer test || php artisan test --fail-on-risk

      - name: Upload backend test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-tests
          path: qava-api/storage/logs

  frontend:
    name: Frontend (React)
    runs-on: ubuntu-latest
    needs: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./qava-portal
        run: npm ci

      - name: Build frontend
        working-directory: ./qava-portal
        run: npm run build

      - name: Upload build artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: qava-portal/dist
